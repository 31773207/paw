<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AttendFlow - Attendance</title>
<link rel="stylesheet" href="style.css">
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
<script src="script.js" defer></script>
</head>
<body class="attendance-page">

<nav class="navbar" style="background-color:#ffffff4c;">
  <div class="logo">AttendFlow</div>
  <ul class="nav-links">
    <li><a href="home.html">Home</a></li>
    <li><a href="attendance.html" class="active">List</a></li>
    <li><a href="addstudent.html">Add Student</a></li>
    <li><a href="reports.html">Reports</a></li>
    <li><a href="../logout.html" class="logout">Logout</a></li>
  </ul>
</nav>

<h1 class="page-title" style="color: #459AA6; font-size: 50px;">Attendance List</h1>

<!-- Add Course/Group Selection -->
<div class="selection-bar" style="margin: 20px 0; padding: 20px; background: linear-gradient(135deg, #459ba621, #51bccc75); border-radius: 12px; box-shadow: 0 4px 12px rgba(69, 154, 166, 0.2);">
    <label style="margin-right: 25px; color: white; font-weight: 600; font-size: 16px;">
        üìö Course: 
       <!-- <select id="courseSelect" style="margin-left: 8px; padding: 8px 12px; border: none; border-radius: 6px; background: white; color: #333; font-size: 14px; cursor: pointer; min-width: 180px;">
            <option value="webdev">Web Development</option>
            <option value="database">Database Systems</option>
        </select>
    </label>
    
    <label style="margin-right: 25px; color: white; font-weight: 600; font-size: 16px;">
        üë• Group: 
        <select id="groupSelect" style="margin-left: 8px; padding: 8px 12px; border: none; border-radius: 6px; background: white; color: #333; font-size: 14px; cursor: pointer; min-width: 120px; margin-top: 10px;">
            <option value="group1">Group 01</option>
            <option value="group2">Group 02</option>
        </select>-->
<select id="courseSelect" style="margin-left: 8px; padding: 8px 12px; border: none; border-radius: 6px; background: white; color: #333; font-size: 14px; cursor: pointer; min-width: 180px;">
    <option value="WEB101">Web Development</option>
    <option value="DB101">Database Systems</option>
</select>

<select id="groupSelect" style="margin-left: 8px; padding: 8px 12px; border: none; border-radius: 6px; background: white; color: #333; font-size: 14px; cursor: pointer; min-width: 120px;">
    <option value="Group 01">Group 01</option>
    <option value="Group 02">Group 02</option>
</select>

    </label>
    
   <button id="loadStudentsBtn" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; margin: 10px;">
    Load Students
</button>

<table id="attendanceTable">
    <thead>
        <tr>
            <th rowspan="2">ID</th>
            <th rowspan="2">Last Name</th>
            <th rowspan="2">First Name</th>
            <th colspan="2">S1</th>
            <th colspan="2">S2</th>
            <th colspan="2">S3</th>
            <th colspan="2">S4</th>
            <th colspan="2">S5</th>
            <th colspan="2">S6</th>
            <th rowspan="2">Participation</th>
            <th rowspan="2">Absence</th>
            <th rowspan="2">Message</th>
            <th rowspan="2">Delete</th>
        </tr>
        <tr>
            <!-- Sub-headers for all sessions -->
            <th>A</th><th>P</th>
            <th>A</th><th>P</th>
            <th>A</th><th>P</th>
            <th>A</th><th>P</th>
            <th>A</th><th>P</th>
            <th>A</th><th>P</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<div class="attend-btn" style="padding-top: 40px;">
    <div class="left-btn">
        <button id="processBtn" style="background-color:#51BBCC;">Update Attendance</button>
        <button id="highlightExcellent" style="background-color:#51BBCC;">Highlight Excellent</button>
        <button id="resetColors" style="background-color:#51BBCC;">Reset Colors</button>
    </div>
    <div class="right-btn">
        <a href="reports.html">
            <button style="background-color:#459AA6;">Show Report</button>
        </a>
    </div>
</div>
<!---
<script>



/// Main load function with better error handling
function loadAttendanceData() {
    const course = document.getElementById('courseSelect').value;
    const group = document.getElementById('groupSelect').value;
    
    console.log('Loading students for: ' + course + ' - ' + group);
    
    // Show loading message
    document.querySelector('#attendanceTable tbody').innerHTML = 
        '<tr><td colspan="20" style="text-align:center; padding:20px;">üîÑ Loading students from database...</td></tr>';
    
    // First, let's test if we can find any PHP file to determine the correct base path
    testBasePath(course, group);
}

function testBasePath(course, group) {
    const testPaths = [
        'get_students.php',
        './get_students.php',
        '../get_students.php',
        '../../get_students.php',
        'db/get_students.php',
        './db/get_students.php',
        '../db/get_students.php',
        '../../db/get_students.php',
        '/db/get_students.php',
        'attendance/get_students.php',
        '../attendance/get_students.php'
    ];
    
    tryPaths(testPaths, 0, course, group);
}

function tryPaths(paths, index, course, group) {
    if (index >= paths.length) {
        // All paths failed - show helpful message
        document.querySelector('#attendanceTable tbody').innerHTML = 
            '<tr><td colspan="20" style="text-align:center; padding:20px; color:red;">' +
            '‚ùå Cannot connect to database. Please check:<br>' +
            '1. PHP file exists in correct location<br>' +
            '2. Database is running<br>' +
            '3. File permissions are correct<br><br>' +
            '<button onclick="showDemoData()" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">' +
            'Show Demo Data Instead</button>' +
            '</td></tr>';
        return;
    }
    
    const path = paths[index];
    const url = path + '?course=' + encodeURIComponent(course) + '&group=' + encodeURIComponent(group) + '&t=' + Date.now();
    
    console.log('Trying path [' + index + ']: ' + path);
    
    fetch(url)
        .then(response => {
            if (response.ok) {
                return response.text().then(text => {
                    console.log('‚úÖ SUCCESS with path: ' + path);
                    console.log('Raw response:', text);
                    
                    try {
                        // Remove PHP comments and parse JSON
                        const jsonText = text.replace(/\/\*.*?\*\//g, '').trim();
                        const students = JSON.parse(jsonText);
                        
                        if (students && Array.isArray(students)) {
                            displayStudents(students);
                        } else {
                            throw new Error('Invalid data format');
                        }
                    } catch (parseError) {
                        console.error('JSON parse error:', parseError);
                        throw new Error('Invalid JSON response');
                    }
                });
            } else {
                throw new Error('HTTP ' + response.status);
            }
        })
        .catch(error => {
            console.log('‚ùå Path failed: ' + path + ' - ' + error.message);
            // Try next path
            setTimeout(() => {
                tryPaths(paths, index + 1, course, group);
            }, 100);
        });
}

// Dynamic display function with clickable cells
// Dynamic display function with clickable cells - REPLACE THIS FUNCTION
function displayStudents(students) {
    const tbody = document.querySelector('#attendanceTable tbody');
    tbody.innerHTML = '';
    
    if (!Array.isArray(students) || students.length === 0) {
        tbody.innerHTML = '<tr><td colspan="20" style="text-align:center; padding:20px; color:#666;">No students found in database for this course/group</td></tr>';
        return;
    }
    
    const course = document.getElementById('courseSelect').value;
    const studentIds = students.map(student => student.id);
    
    // Load saved attendance first
    fetch('../db/get_saved_attendance.php', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            course: course,
            student_ids: studentIds
        })
    })
    .then(response => response.json())
    .then(savedAttendance => {
        // Now render students with their saved attendance
        renderStudents(students, savedAttendance);
    })
    .catch(error => {
        console.log('No saved attendance found');
        renderStudents(students, []);
    });
}

// ADD THIS NEW FUNCTION
function renderStudents(students, savedAttendance) {
    const tbody = document.querySelector('#attendanceTable tbody');
    tbody.innerHTML = '';
    
    students.forEach(student => {
        const row = document.createElement('tr');
        
        // Generate session cells with saved data
        let sessionCells = '';
        for (let i = 1; i <= 6; i++) {
            // Find saved attendance for this student and session
           const savedSession = savedAttendance.find(s => 
    s.student_id === student.id && s.session_id === i
);
            
            const presentStatus = savedSession ? savedSession.status : 'empty';
            const presentSymbol = presentStatus === 'present' ? '‚úÖ' : '';
            const presentColor = presentStatus === 'present' ? '#d4ffd4' : '';
            
            const participationStatus = (savedSession && savedSession.participation === 100) ? 'participation' : 'empty';
            const participationSymbol = participationStatus === 'participation' ? '‚≠ê' : '';
            const participationColor = participationStatus === 'participation' ? '#e6f7ff' : '';
            
            sessionCells += `
                <td class="present-cell clickable" data-student="${student.id}" data-session="${i}" data-status="${presentStatus}" style="background-color: ${presentColor}">${presentSymbol}</td>
                <td class="absent-cell clickable" data-student="${student.id}" data-session="${i}" data-status="${participationStatus}" style="background-color: ${participationColor}">${participationSymbol}</td>
            `;
        }
        
        // Calculate absence count from saved data
const studentSessions = savedAttendance.filter(s => s.student_id === student.id);
        const presentCount = studentSessions.filter(s => s.status === 'present').length;
        const absenceCount = 6 - presentCount;
        
        row.innerHTML = `
            <td><strong>${student.id}</strong></td>
            <td><strong>${student.last_name}</strong></td>
            <td><strong>${student.first_name}</strong></td>
            ${sessionCells}
            <td class="participation-cell">${calculateParticipation(studentSessions)}%</td>
            <td class="absence-count" data-student="${student.id}">${absenceCount}</td>
            <td class="message-cell" data-student="${student.id}">${getStatusMessage(presentCount)}</td>
            <td><button class="delete-btn" onclick="deleteStudent('${student.id}')">üóëÔ∏è</button></td>
        `;
        
        tbody.appendChild(row);
    });
    
    // Add click handlers after creating the table
    addClickHandlers();
    
    console.log('‚úÖ Loaded ' + students.length + ' students with saved attendance');
}

// ADD THESE HELPER FUNCTIONS
function calculateParticipation(sessions) {
    if (sessions.length === 0) return 0;
    const total = sessions.reduce((sum, session) => sum + (session.participation || 0), 0);
    return Math.round(total / sessions.length);
}

function getStatusMessage(presentCount) {
    if (presentCount === 6) return 'Excellent üåü';
    if (presentCount >= 4) return 'Good ‚úÖ';
    if (presentCount >= 3) return 'Warning ‚ö†Ô∏è';
    return 'Critical üö®';
}

// Dynamic click handlers for attendance tracking
function addClickHandlers() {
    // Present cell click - cycles through options
    document.querySelectorAll('.present-cell.clickable').forEach(cell => {
        cell.addEventListener('click', function() {
            const currentStatus = this.getAttribute('data-status');
            const studentId = this.getAttribute('data-student');
            const session = this.getAttribute('data-session');
            
            let newStatus, newSymbol;
            
            if (currentStatus === 'empty') {
                newStatus = 'present';
                newSymbol = '‚úÖ';
            } else if (currentStatus === 'present') {
                newStatus = 'absent';
                newSymbol = '‚ùå';
            } else {
                newStatus = 'empty';
                newSymbol = '';
            }
            
            this.setAttribute('data-status', newStatus);
            this.textContent = newSymbol;
            
            // Add color coding
            this.style.backgroundColor = newStatus === 'present' ? '#d4ffd4' : 
                                       newStatus === 'absent' ? '#ffd4d4' : 
            
            // Update absence count and message
            updateStudentStats(studentId);
            
            console.log(`Student ${studentId}, Session ${session}: ${newStatus}`);
        });
    });

    // Absent cell click - simple toggle
    document.querySelectorAll('.absent-cell.clickable').forEach(cell => {
        cell.addEventListener('click', function() {
            const currentStatus = this.getAttribute('data-status');
            const studentId = this.getAttribute('data-student');
            const session = this.getAttribute('data-session');
            
            let newStatus, newSymbol;
            
            if (currentStatus === 'empty') {
                newStatus = 'participation';
                newSymbol = '‚úÖ';
            } else {
                newStatus = 'empty';
                newSymbol = '';
            }
            
            this.setAttribute('data-status', newStatus);
            this.textContent = newSymbol;
            
            // Add color coding
            this.style.backgroundColor = newStatus === 'participation' ? '#d4ffd4' : '';
            
            // Update absence count and message
            updateStudentStats(studentId);
            
            console.log(`Student ${studentId}, Session ${session}: ${newStatus}`);
        });
    });

    
}

// Update student statistics (absence count and message)
// Update student statistics (absence count and message) - REPLACE THIS FUNCTION
function updateStudentStats(studentId) {
    const studentRow = document.querySelector(`[data-student="${studentId}"]`).closest('tr');
    let presentCount = 0;
    
    // Count present sessions (both regular present and participation)
    for (let session = 1; session <= 6; session++) {
        const presentCell = studentRow.querySelector(`.present-cell[data-session="${session}"]`);
        const absentCell = studentRow.querySelector(`.absent-cell[data-session="${session}"]`);
        
        if ((presentCell && presentCell.getAttribute('data-status') === 'present') ||
            (absentCell && absentCell.getAttribute('data-status') === 'participation')) {
            presentCount++;
        }
    }
    
    const absenceCount = 6 - presentCount;
    
    // Update absence count
    const absenceCountCell = studentRow.querySelector('.absence-count');
    absenceCountCell.textContent = absenceCount;
    
    // Update message
    const messageCell = studentRow.querySelector('.message-cell');
    messageCell.textContent = getStatusMessage(presentCount);
}

// Demo data fallback
function showDemoData() {
    const demoStudents = [
        {id: '2023001', last_name: 'Ben Ahmed', first_name: 'Ali'},
        {id: '2023002', last_name: 'Toumi', first_name: 'Sarah'},
        {id: '2023003', last_name: 'Youcef', first_name: 'Hiba'},
        {id: '2023004', last_name: 'Benzerga', first_name: 'Mohamed'},
        {id: '2023005', last_name: 'Boudiaf', first_name: 'Fatima'}
    ];
    
    displayStudents(demoStudents);
    console.log('üìã Showing demo data');
}

function deleteStudent(studentId) {
    if (confirm('Are you sure you want to delete student ' + studentId + '?')) {
        console.log('Deleting student:', studentId);
        // Add your delete logic here
        alert('Student ' + studentId + ' would be deleted (delete function not implemented)');
    }
}

// Button functions
// Button functions - REPLACE THIS FUNCTION
// FIXED updateAttendance function - NO AUTO-RELOAD
function updateAttendance() {
    const course = document.getElementById('courseSelect').value;
    const group = document.getElementById('groupSelect').value;
    const attendanceData = [];
    
    // Collect all attendance data from the table
    document.querySelectorAll('#attendanceTable tbody tr').forEach(row => {
        const studentId = row.cells[0].textContent.trim();
        
        // Process each session (S1 to S6)
        for (let session = 1; session <= 6; session++) {
            const presentCell = row.querySelector(`.present-cell[data-session="${session}"]`);
            const participationCell = row.querySelector(`.participation-cell[data-session="${session}"]`);
            
            let status = 'absent';
            let participation = 0;
            
            // Check present cell
            if (presentCell && presentCell.getAttribute('data-status') === 'present') {
                status = 'present';
                participation = 80;
            }
            // Check participation cell
            else if (participationCell && participationCell.getAttribute('data-status') === 'participation') {
                status = 'present';
                participation = 100;
            }
            
            // Save all records (including absent to clear previous data)
            attendanceData.push({
                student_id: studentId,
                session: session,
                status: status,
                participation: participation
            });
        }
    });
    
    if (attendanceData.length === 0) {
        alert('‚ùå No attendance data to save! Please mark some students first.');
        return;
    }
    
    console.log('Saving to database:', attendanceData);
    
    // Show saving state
    const processBtn = document.getElementById('processBtn');
    const originalText = processBtn.textContent;
    processBtn.textContent = 'üîÑ Saving...';
    processBtn.disabled = true;
    
    // Save to database
    fetch('../db/save_attendance.php', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            course: course,
            attendance: attendanceData
        })
    })
    .then(response => {
        console.log('Response status:', response.status);
        return response.text().then(text => {
            console.log('Raw response:', text);
            try {
                return JSON.parse(text);
            } catch (e) {
                console.error('JSON parse error:', e);
                throw new Error('Invalid JSON response: ' + text.substring(0, 100));
            }
        });
    })
    .then(data => {
        console.log('Parsed response:', data);
        if (data.success) {
            alert(`‚úÖ Attendance saved successfully for ${attendanceData.length} records!`);
            // REMOVED THE AUTO-RELOAD - table stays as is
            // Optional: Just show success message without reloading
        } else {
            alert('‚ùå Error: ' + (data.error || data.message || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Full error:', error);
        alert('‚ùå Network error: ' + error.message);
    })
    .finally(() => {
        processBtn.textContent = originalText;
        processBtn.disabled = false;
    });
}

function highlightExcellent() {
    const rows = document.querySelectorAll('#attendanceTable tbody tr');
    let highlighted = 0;
    
    rows.forEach(row => {
        const messageCell = row.querySelector('.message-cell');
        if (messageCell && messageCell.textContent.includes('Excellent')) {
            row.style.outline='3px solid #00b3b3';
          row.style.backgroundColor='#b3ffb3';
        }
    });
  }

function resetColors() {
    const rows = document.querySelectorAll('#attendanceTable tbody tr');
    rows.forEach(row => {
        row.style.backgroundColor = '';
    });
    alert('üé® Colors reset!');
}

// Setup
document.addEventListener('DOMContentLoaded', function() {
    const loadBtn = document.getElementById('loadStudentsBtn');
    if (loadBtn) {
        loadBtn.addEventListener('click', loadAttendanceData);
        console.log('‚úÖ Load Students button ready');
    }
    
    // Setup other buttons
    document.getElementById('processBtn').addEventListener('click', updateAttendance);
    document.getElementById('highlightExcellent').addEventListener('click', highlightExcellent);
    document.getElementById('resetColors').addEventListener('click', resetColors);
    
    // Start message
    document.querySelector('#attendanceTable tbody').innerHTML = 
        '<tr><td colspan="20" style="text-align:center; padding:20px; color:#666;">üëÜ Click "Load Students" to load from database</td></tr>';
});

// Add this function to help debug - call it in browser console
window.debugPaths = function() {
    const testUrl = 'get_students.php?course=WEB101&group=Group 01';
    console.log('Testing basic path:', testUrl);
    
    fetch(testUrl)
        .then(r => console.log('Basic test:', r.status, r.statusText))
        .catch(e => console.log('Basic test error:', e.message));
};

// Add CSS for better clickable cells
const style = document.createElement('style');
style.textContent = `
    .clickable {
        cursor: pointer;
        transition: background-color 0.2s ease;
        text-align: center;
        font-weight: bold;
        min-width: 40px;
        height: 40px;
    }
    
    .clickable:hover {
        opacity: 0.8;
        transform: scale(1.05);
    }
    
    .present-cell, .absent-cell, .participation-cell {
        border-radius: 4px;
        margin: 2px;
    }
    
    .message-cell {
        font-weight: bold;
        text-align: center;
    }
    
    .absence-count {
        font-weight: bold;
        text-align: center;
        color: #dc3545;
    }
`;
document.head.appendChild(style);
</script>-->

</body>
</html> 